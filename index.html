<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šæ˜Ÿåº§è¿åŠ¿ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #16a085, #f4d03f);
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .horoscope-item {
            border-left: 4px solid #3498db;
        }
        .scrollable-content {
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #3498db;
            border-radius: 4px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background-color: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="container bg-gradient-to-br from-green-500 to-yellow-500">
        <div class="card p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center">
            
            <!-- Header -->
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2">ğŸŒŸ ä¸“ä¸šæ˜Ÿåº§è¿åŠ¿ç”Ÿæˆå™¨ ğŸŒŸ</h1>
            <p class="text-gray-600 mb-6">ğŸ”® åŸºäºä¸“ä¸š API + é«˜ç«¯å¤‡ç”¨åº“</p>

            <!-- Status Message -->
            <div id="statusMessage" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

            <!-- Buttons -->
            <div class="space-y-4 md:space-y-0 md:space-x-4 mb-8">
                <button id="fetchBtn" class="btn w-full md:w-auto bg-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-600 transition duration-300">
                    ğŸŒŸ è·å–ä¸“ä¸šè¿åŠ¿
                </button>
                <button id="testApiBtn" class="btn w-full md:w-auto bg-gray-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-600 transition duration-300">
                    ğŸ”§ æµ‹è¯•APIè¿æ¥
                </button>
                <button id="downloadBtn" class="btn w-full md:w-auto bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-600 transition duration-300 hidden">
                    ğŸ“¥ ä¸‹è½½æµ·æŠ¥
                </button>
                <button id="clearBtn" class="btn w-full md:w-auto bg-red-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-red-600 transition duration-300">
                    âŒ æ¸…é™¤ç»“æœ
                </button>
            </div>

            <!-- Poster Display -->
            <div id="posterDisplay" class="scrollable-content bg-gray-100 p-6 rounded-xl shadow-inner text-left w-full">
                <p class="text-center text-gray-500">è¯·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆæˆ–æµ‹è¯•è¿åŠ¿ä¿¡æ¯ã€‚</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const constellations = ["ç™½ç¾Šåº§", "é‡‘ç‰›åº§", "åŒå­åº§", "å·¨èŸ¹åº§", "ç‹®å­åº§", "å¤„å¥³åº§", "å¤©ç§¤åº§", "å¤©èåº§", "å°„æ‰‹åº§", "æ‘©ç¾¯åº§", "æ°´ç“¶åº§", "åŒé±¼åº§"];
        const fallbackHoroscope = {
            "ç™½ç¾Šåº§": "ç«æ˜Ÿèƒ½é‡æ¿€å‘è¡ŒåŠ¨åŠ›ï¼Œä»Šæ—¥é€‚åˆä¸»åŠ¨å‡ºå‡»ã€‚å»ºè®®æŠŠæ¡æœºé‡ï¼Œå‹‡æ•¢è¡¨è¾¾æƒ³æ³•ã€‚",
            "é‡‘ç‰›åº§": "é‡‘æ˜Ÿå®ˆæŠ¤ä¸‹å¿ƒå¢ƒå¹³å’Œï¼Œä»Šæ—¥é€‚åˆå¤„ç†è´¢åŠ¡äº‹å®œã€‚ç¨³é‡æ€åº¦ä¼šèµ¢å¾—ä»–äººä¿¡ä»»ã€‚",
            "åŒå­åº§": "æ°´æ˜Ÿå¸¦æ¥æ•é”æ€ç»´ï¼Œæ²Ÿé€šè¡¨è¾¾èƒ½åŠ›è¾¾åˆ°å³°å€¼ã€‚å­¦ä¹ æ–°çŸ¥è¯†çš„å¥½æ—¶æœºã€‚",
            "å·¨èŸ¹åº§": "æœˆäº®å½±å“ä¸‹æƒ…æ„Ÿæ•é”ï¼Œå®¶åº­è¿åŠ¿ç‰¹åˆ«å¥½ã€‚ç›´è§‰èƒ½åŠ›å¢å¼ºï¼Œé€‚åˆåšé‡è¦å†³å®šã€‚",
            "ç‹®å­åº§": "å¤ªé˜³ç…§è€€ä¸‹è‡ªä¿¡æ»¡æ»¡ï¼Œåˆ›é€ åŠ›è¾¾åˆ°é«˜å³°ã€‚é€‚åˆå±•ç¤ºæ‰åï¼Œæˆä¸ºä¼—äººç„¦ç‚¹ã€‚",
            "å¤„å¥³åº§": "åœŸè±¡èƒ½é‡å¸¦æ¥åŠ¡å®ç²¾ç¥ï¼Œæ³¨é‡ç»†èŠ‚çš„å¤©æ€§å¸®ä½ æŠŠå·¥ä½œåšåˆ°å®Œç¾ã€‚",
            "å¤©ç§¤åº§": "é‡‘æ˜Ÿå¸¦æ¥å’Œè°èƒ½é‡ï¼Œå®¡ç¾èƒ½åŠ›å’Œç¤¾äº¤é­…åŠ›çªå‡ºã€‚é€‚åˆå¤„ç†äººé™…å…³ç³»ã€‚",
            "å¤©èåº§": "å†¥ç‹æ˜Ÿæ·±åº¦å½±å“ï¼Œæ´å¯ŸåŠ›å’Œç›´è§‰è¾¾åˆ°å·…å³°ã€‚é€‚åˆæ·±å…¥åˆ†æé—®é¢˜ã€‚",
            "å°„æ‰‹åº§": "æœ¨æ˜Ÿæ‰©å±•è¿åŠ¿ï¼Œä¹è§‚ç²¾ç¥æ„ŸæŸ“å‘¨å›´çš„äººã€‚é€‚åˆæ¢ç´¢æ–°é¢†åŸŸã€‚",
            "æ‘©ç¾¯åº§": "åœŸæ˜Ÿç¨³é‡å½±å“ï¼Œç›®æ ‡å¯¼å‘æ€§å¼ºã€‚é•¿æœŸè§„åˆ’å¼€å§‹æ˜¾ç°æˆæ•ˆã€‚",
            "æ°´ç“¶åº§": "å¤©ç‹æ˜Ÿåˆ›æ–°èƒ½é‡ï¼Œç‹¬ç‰¹æƒ³æ³•å—åˆ°å…³æ³¨ã€‚å‹è°Šè¿åŠ¿ç‰¹åˆ«å¥½ã€‚",
            "åŒé±¼åº§": "æµ·ç‹æ˜Ÿæ¢¦å¹»å½±å“ï¼Œæƒ³è±¡åŠ›å’Œç›´è§‰èƒ½åŠ›è¾¾åˆ°é«˜å³°ã€‚è‰ºæœ¯å¤©èµ‹çªå‡ºã€‚"
        };

        let isLoading = false;
        
        // Helper function to get element by ID and prevent errors
        function safeGetElement(id) {
            return document.getElementById(id);
        }

        function showStatus(message, type = 'info') {
            const statusEl = safeGetElement('statusMessage');
            if (statusEl) {
                statusEl.innerHTML = message;
                statusEl.className = `p-3 mb-4 text-sm rounded-lg transition-all duration-300 block`;
                if (type === 'success') {
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                } else {
                    statusEl.classList.add('bg-blue-100', 'text-blue-800');
                }
            }
        }

        function hideStatus() {
            const statusEl = safeGetElement('statusMessage');
            if (statusEl) {
                statusEl.classList.add('hidden');
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                if (loading) {
                    btn.disabled = true;
                    if (btn.id === 'fetchBtn') {
                        btn.innerHTML = '<span class="loading-spinner"></span>è·å–ä¸­...';
                    } else if (btn.id === 'testApiBtn') {
                        btn.innerHTML = '<span class="loading-spinner"></span>æµ‹è¯•ä¸­...';
                    }
                } else {
                    btn.disabled = false;
                    if (btn.id === 'fetchBtn') {
                        btn.innerHTML = 'ğŸŒŸ è·å–ä¸“ä¸šè¿åŠ¿';
                    } else if (btn.id === 'testApiBtn') {
                        btn.innerHTML = 'ğŸ”§ æµ‹è¯•APIè¿æ¥';
                    }
                }
            });
        }
        
        // Simulate an API call with mock data
        async function fetchMockHoroscope(constellation) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const randomNumber = Math.random();
                    if (randomNumber < 0.9) {
                        // Simulate success
                        resolve({
                            constellation: constellation,
                            summary: fallbackHoroscope[constellation],
                            lucky_color: ["è“è‰²", "ç»¿è‰²", "é‡‘è‰²", "çº¢è‰²", "ç´«è‰²"][Math.floor(Math.random() * 5)],
                            lucky_number: Math.floor(Math.random() * 10) + 1,
                            lucky_constellation: constellations[Math.floor(Math.random() * 12)],
                            api_source: "èšåˆæ•°æ®ä¸“ä¸šç‰ˆ (æ¨¡æ‹Ÿ)"
                        });
                    } else {
                        // Simulate failure
                        resolve({
                            constellation: constellation,
                            summary: fallbackHoroscope[constellation],
                            lucky_color: ["è“è‰²", "ç»¿è‰²", "é‡‘è‰²", "çº¢è‰²", "ç´«è‰²"][Math.floor(Math.random() * 5)],
                            lucky_number: Math.floor(Math.random() * 10) + 1,
                            lucky_constellation: constellations[Math.floor(Math.random() * 12)],
                            api_source: "ä¸“ä¸šå¤‡ç”¨æ•°æ®åº“ (æ¨¡æ‹Ÿ)"
                        });
                    }
                }, 500); // Simulate network delay
            });
        }

        async function createPoster() {
            if (isLoading) return;
            setLoading(true);
            hideStatus();
            const posterDisplay = safeGetElement('posterDisplay');
            posterDisplay.innerHTML = '<p class="text-center text-gray-500">æ­£åœ¨è·å–è¿åŠ¿æ•°æ®...</p>';

            const horoscopes = [];
            for (const constellation of constellations) {
                const data = await fetchMockHoroscope(constellation);
                horoscopes.push(data);
            }

            let htmlContent = `<div class="p-4">
                <h2 class="text-center text-xl font-bold mb-4">ğŸŒŸ ä»Šæ—¥æ˜Ÿåº§è¿åŠ¿</h2>
                <p class="text-center text-sm text-gray-500 mb-4">${new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>`;

            horoscopes.forEach(data => {
                const luckyInfo = `${data.lucky_color} | ${data.lucky_number} | ${data.lucky_constellation}`;
                htmlContent += `
                    <div class="horoscope-item p-4 mb-4 rounded-lg shadow-md bg-white">
                        <div class="flex items-center mb-2">
                            <span class="text-3xl mr-2">â­</span>
                            <h3 class="text-xl font-semibold text-blue-600">${data.constellation}</h3>
                        </div>
                        <p class="text-gray-700 leading-relaxed mb-2">${data.summary}</p>
                        <p class="text-xs text-gray-500 flex items-center">
                            <span class="mr-2">ğŸ€</span>
                            <span class="mr-4">å¹¸è¿è‰²: ${data.lucky_color}</span>
                            <span class="mr-4">å¹¸è¿æ•°å­—: ${data.lucky_number}</span>
                            <span>è´µäººæ˜Ÿåº§: ${data.lucky_constellation}</span>
                        </p>
                    </div>
                `;
            });
            
            posterDisplay.innerHTML = htmlContent;
            showStatus('âœ… è¿åŠ¿æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼', 'success');
            setLoading(false);
            safeGetElement('downloadBtn').classList.remove('hidden');
        }

        async function testApiConnection() {
            if (isLoading) return;
            setLoading(true);
            hideStatus();
            safeGetElement('downloadBtn').classList.add('hidden');
            const posterDisplay = safeGetElement('posterDisplay');
            posterDisplay.innerHTML = '<p class="text-center text-gray-500">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</p>';

            const testResult = await fetchMockHoroscope('ç‹®å­åº§');

            let htmlContent;
            if (testResult.api_source.includes('èšåˆæ•°æ®')) {
                showStatus('âœ… APIè¿æ¥æˆåŠŸï¼æ•°æ®è·å–æ­£å¸¸ã€‚', 'success');
                htmlContent = `<div class="p-4">
                    <h3 class="text-xl font-bold mb-2 text-green-600">æµ‹è¯•æˆåŠŸï¼</h3>
                    <p class="text-gray-700"><strong>æ˜Ÿåº§:</strong> ${testResult.constellation}</p>
                    <p class="text-gray-700"><strong>è¿åŠ¿æ‘˜è¦:</strong> ${testResult.summary.substring(0, 50)}...</p>
                    <p class="text-gray-700"><strong>æ•°æ®æº:</strong> ${testResult.api_source}</p>
                </div>`;
            } else {
                showStatus('âŒ APIè¿æ¥å¤±è´¥ï¼Œå·²ä½¿ç”¨å¤‡ç”¨æ•°æ®ã€‚', 'error');
                htmlContent = `<div class="p-4">
                    <h3 class="text-xl font-bold mb-2 text-red-600">æµ‹è¯•å¤±è´¥ï¼</h3>
                    <p class="text-gray-700">è¯·æ£€æŸ¥APIå¯†é’¥æˆ–ç½‘ç»œè¿æ¥ã€‚</p>
                    <p class="text-700"><strong>å·²è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®åº“ã€‚</strong></p>
                </div>`;
            }
            posterDisplay.innerHTML = htmlContent;
            setLoading(false);
        }
        
        function clearResults() {
            const posterDisplay = safeGetElement('posterDisplay');
            if (posterDisplay) {
                posterDisplay.innerHTML = '<p class="text-center text-gray-500">å·²æ¸…é™¤æ‰€æœ‰ç»“æœã€‚</p>';
                hideStatus();
                safeGetElement('downloadBtn').classList.add('hidden');
            }
        }
        
        async function downloadPoster() {
            const posterDisplay = safeGetElement('posterDisplay');
            if (!posterDisplay || isLoading) return;
            
            showStatus('ğŸš€ æ­£åœ¨ç”Ÿæˆæµ·æŠ¥å›¾ç‰‡...', 'info');

            // ä¸´æ—¶ä¿å­˜åŸå§‹æ ·å¼
            const originalMaxHeight = posterDisplay.style.maxHeight;
            const originalOverflowY = posterDisplay.style.overflowY;

            // ç§»é™¤é™åˆ¶ä»¥ç¡®ä¿æ•è·å®Œæ•´å†…å®¹
            posterDisplay.style.maxHeight = 'none';
            posterDisplay.style.overflowY = 'visible';

            html2canvas(posterDisplay, {
                allowTaint: true,
                useCORS: true,
                scale: 2 // å¢åŠ åˆ†è¾¨ç‡ï¼Œç¡®ä¿å›¾ç‰‡æ¸…æ™°
            }).then(function(canvas) {
                const dataUrl = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                link.download = 'æ˜Ÿåº§è¿åŠ¿æµ·æŠ¥.png';
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatus('ğŸ‰ æµ·æŠ¥ä¸‹è½½æˆåŠŸï¼', 'success');
            })
            .catch(function (error) {
                console.error('Oops, something went wrong!', error);
                showStatus('âŒ ä¸‹è½½æµ·æŠ¥å¤±è´¥ã€‚è¯·ç¨åé‡è¯•ã€‚', 'error');
            })
            .finally(() => {
                // æ¢å¤åŸå§‹æ ·å¼ï¼Œä¿æŒUIçš„æ»šåŠ¨åŠŸèƒ½
                posterDisplay.style.maxHeight = originalMaxHeight;
                posterDisplay.style.overflowY = originalOverflowY;
            });
        }

        // Add event listeners
        safeGetElement('fetchBtn').addEventListener('click', createPoster);
        safeGetElement('testApiBtn').addEventListener('click', testApiConnection);
        safeGetElement('clearBtn').addEventListener('click', clearResults);
        safeGetElement('downloadBtn').addEventListener('click', downloadPoster);
    </script>
</body>
</html>
